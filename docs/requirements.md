# 要件定義書：抽象画像編集Webアプリ（EternalAI連携）

## 1. 目的
- ユーザーが人物写真をアップロードし、自然言語の指示で画像を編集して受け取れる体験を提供する。
- 待ち時間のストレスを軽減し、指示が苦手なユーザーでも扱いやすい親切設計を実現する。

## 2. 想定ユーザー / ユースケース
- 画像を修正したい一般ユーザー。
- SNS 用のプロフィール画像を整えたい人や、背景・服装などを直感的に変更したい非デザイナー。

## 3. 成果物
- Web アプリケーション（シングルページアプリケーション）。
- EternalAI の `uncensored-image` API（`type=edit`）を利用した画像変換機能。

## 4. 画面一覧（最小構成）
1. **ホーム / アップロード画面**
   - 画像ドロップ / 選択、次へボタン。
2. **編集指示画面（チャット UI）**
   - 画像プレビュー、指示入力欄、送信ボタン。
   - 入力欄の下に候補チップ（サンプル A/B/C…）を常時表示（後で差し替え可能）。
3. **処理中モーダル（非ブロッキング）**
   - 進行アニメーション、揺らぎのある進捗表示、Tips カルーセル。
   - メッセージ例：「画像を生成中です（通常 10–40 秒程度）」「編集のこつ」など。
4. **結果画面**
   - 出力画像は 1 枚のみ表示。
   - ダウンロード（PNG/JPEG）/再編集/やり直し。

## 5. 主要ユーザーフロー
1. 画像をアップロード → 次へ。
2. 指示を入力（候補チップをクリックで追記可）→ 送信。
3. 処理中モーダルが表示（数十秒想定の演出）→ 完了通知。
4. 結果画面でプレビュー → ダウンロード or 再編集。

## 6. 機能要件
### 6.1 画像アップロード
- 拡張子・ MIME の整合性チェック、ファイルサイズ・寸法上限の検証。
- アップロード後、プレビュー表示および状態遷移（`idle → uploading → ready`）。

### 6.2 指示入力と候補チップ
- テキスト入力（プレースホルダー例：「例：背景を海に。肌は自然なまま。」）。
- 候補チップ（サンプル A/B/C…）：クリックで入力欄へ追記。
- 入力バリデーション：最小文字数・禁止語（運用ポリシーで定義）。

### 6.3 EternalAI API 連携（編集リクエスト）
- エンドポイント：`POST https://agentic.eternalai.org/uncensored-image`。
- ヘッダー：`x-api-key: <秘密鍵>`、`Content-Type: application/json`。
- リクエスト例：
  ```json
  {
    "messages": [{
      "role": "user",
      "content": [
        {
          "type": "image_url",
          "image_url": {
            "url": "data:image/jpeg;base64,...",
            "filename": "upload.jpg"
          }
        },
        { "type": "text", "text": "<ユーザー指示文>" }
      ]
    }],
    "type": "edit"
  }
  ```
- レスポンスから `request_id` を取得し、結果ポーリングへ遷移。

### 6.4 結果ポーリング
- エンドポイント：`GET https://agentic.eternalai.org/result/uncensored-image?request_id=<id>`。
- ポーリング間隔：1〜2 秒（指数バックオフ可）。
- ステータス：`processing` / `success` / `failed`。
- `success` 時に `result_url`（署名付き URL）を取得し、画像表示・保存。

### 6.5 進捗 / 待機 UX
- 視覚的演出：パルス / スケルトン / ドットタイプ。
- メッセージ例：
  - 「画像を生成中です。通常は 10–40 秒ほどで完了します。」
  - 「コツ：人物を保持したい場合は“人物はそのまま”と明記すると安定します。」
  - 「Tip：色変更や背景差し替えは具体的な単語が効果的です。」
- Tips カルーセル：3〜5 枚を数秒ごとに切り替え（処理完了時は自動クローズ）。

### 6.6 結果表示 / 配布
- 1 枚の出力画像をプレビュー表示。
- ダウンロード（PNG/JPEG 選択）、クリップボードコピー（対応ブラウザ）。
- 再編集（同一画像・差分指示で再リクエスト）。

### 6.7 エラー / 例外処理
- ネットワーク / タイムアウト：再試行ボタン + 状態保持。
- API 失敗（`failed`）：原因メッセージ要約 + 再編集提案。
- 入力不正：即時バリデーションと改善例を提示。

## 7. 非機能要件
- **パフォーマンス**：初回ロード < 2.5s（LCP 基準）、処理中 FPS を保つ軽量アニメーション。
- **信頼性**：API 障害時はキューと再送（最大 3 回）／ユーザーに明示。
- **セキュリティ / プライバシー**：
  - 画像は原則一時保存（結果配布後、一定時間で削除・手動削除可）。
  - HTTPS 必須、API キーはサーバー側で保護（フロントに出さない）。
  - EXIF 除去、サーバー側で拡張子・ MIME 二重検査。
- **アクセシビリティ**：キーボード操作可能、ARIA ラベル、十分なコントラスト。
- **国際化**：UI 文言は i18n 対応（既定は日本語）。
- **ログ / 監査**：`request_id`・処理時間・失敗理由（個人情報保護法・プライバシーポリシー遵守）。

## 8. システム構成（推奨）
- **フロントエンド**：Next.js + Tailwind CSS。
- **バックエンド**：FastAPI（Python）または Cloud Functions。
  - `/api/edit`：編集依頼 → EternalAI へ転送（API キー保持）。
  - `/api/poll?request_id=...`：結果取得 → URL 返却。
- **ストレージ**：一時保管に S3 互換ストレージ / Firestore Storage（署名 URL で配布）。
- **認証**：不要（匿名利用想定）。

## 9. データモデル（最小）
| フィールド | 説明 |
| --- | --- |
| `id` | 内部 ID |
| `request_id` | EternalAI リクエスト ID |
| `status` | 状態（`idle`/`uploading`/`ready`/`requesting`/`processing`/`success`/`failed`） |
| `created_at` | 作成日時 |
| `completed_at` | 完了日時 |
| `original_image_url` | 元画像の保存先 |
| `result_url` | 結果画像の保存先 |
| `prompt` | ユーザー指示文 |
| `error` | 失敗時のメッセージ |

## 10. 状態遷移
```
idle → uploading → ready → requesting → processing → success | failed
```
- `processing` 中はキャンセル可能（UI のみ、実際の停止は注記）。

## 11. バリデーション要件
- **画像**：拡張子・ MIME 一致、サイズ上限、寸法上限（例：長辺 4096px）。
- **テキスト**：最大 2,000 文字、絵文字可、禁止語辞書（運用で更新）。

## 12. マイクロコピー（初期文言案）
- **アップロード前**：「画像を選択またはここにドロップ」。
- **指示入力プレースホルダー**：「例：背景を海に。服は黒のジャケットに。人物の雰囲気はそのまま。」
- **候補チップ**：サンプル A / サンプル B / サンプル C / サンプル D。
- **処理中**：「画像を生成中です（通常 10–40 秒）。ヒントを表示中…」。

## 13. エラーメッセージ（例）
- 「画像の読み込みに失敗しました。別のファイルでお試しください。」
- 「処理が混み合っています。もう一度リクエストしますか？」
- 「結果の取得に時間がかかっています。完了次第、画面に表示します。」

## 14. 運用 / 課金
- EternalAI 課金：API Key または x402 に対応。
- 利用上限：1 ユーザー / 日あたりの処理数（例：10 件）。
- 画像保持方針：既定で 24 時間保持 → 自動削除（即時削除ボタンあり）。

## 15. 品質保証
- 主要ブラウザ検証（Chrome / Safari / Firefox / Edge、モバイル含む）。
- アップロード / 処理 / 失敗 / 再編集の E2E テスト。
- アクセシビリティ監査（Lighthouse / axe）。
